<?xml version="1.0"?>
<!DOCTYPE PLUGIN [
<!ENTITY name "fanctrlplus">
<!ENTITY version "1.2.2">
<!ENTITY author "ck9393">
<!ENTITY launch "Settings/fanctrlplus">
<!ENTITY txz "/boot/config/plugins/&name;/fanctrlplus-&version;.txz">
<!ENTITY pluginURL "https://github.com/ck9393/fanctrlplus/releases/download/v&version;/fanctrlplus-&version;.txz">
]>

<PLUGIN name="&name;" author="&author;" version="&version;" launch="&launch;" pluginURL="&pluginURL;" min="6.9.0">
<CATEGORY>System</CATEGORY>
<PLUGINURL>https://github.com/ck9393/fanctrlplus</PLUGINURL>

<DESCRIPTION>
FanCtrl Plus: Automatically control fan speed based on disk temperature. This version includes full auto-start support for all array scenarios.
</DESCRIPTION>

<ICON>
/usr/local/emhttp/plugins/fanctrlplus/images/fanctrlplus.png
</ICON>

<!-- æ¸…ç†æ—§ txz -->
<FILE Run="/bin/bash">
<INLINE>
#!/bin/bash
rm -f /boot/config/plugins/fanctrlplus/fanctrlplus-*.txz
</INLINE>
</FILE>

<!-- ä¸‹è½½å¹¶å®‰è£…æ–°çš„ .txz -->
<FILE Name="&txz;" Run="upgradepkg --install-new --reinstall">
<URL>&pluginURL;</URL>
</FILE>

<!-- å¯åŠ¨ array monitor å®ˆæŠ¤è„šæœ¬ -->
<FILE Run="/bin/bash">
<INLINE>
<![CDATA[
#!/bin/bash

# ç¡®ä¿ rc.fanctrlplus æ³¨å†Œè¿› /etc/rc.dï¼ˆUnraid ä¼šè°ƒç”¨è¿™é‡Œï¼‰
src="/usr/local/emhttp/plugins/fanctrlplus/scripts/rc.fanctrlplus"
dst="/etc/rc.d/rc.fanctrlplus"
if [ -f "$src" ]; then
ln -sf "$src" "$dst"
fi

# è‹¥ä¹‹å‰å¯åŠ¨è¿‡ï¼Œå…ˆæ€æ‰
pkill -f "/usr/local/emhttp/plugins/fanctrlplus/scripts/array_monitor.sh"

# å¯åŠ¨ array monitor å®ˆæŠ¤è„šæœ¬
script="/usr/local/emhttp/plugins/fanctrlplus/scripts/array_monitor.sh"
if [ -x "$script" ]; then
nohup "$script" >/dev/null 2>&1 &
fi
]]>

echo ""
echo "------------------------------------------------"
echo " Plugin &name; is installed."
echo " Array monitor is running."
echo " Author: &author;"
echo " Version: &version;"
echo "------------------------------------------------"
echo ""
exit 0
</INLINE>
</FILE>

<!-- å¸è½½æ—¶æ¸…ç†åå°å’Œæ–‡ä»¶ -->
<FILE Run="/bin/bash" Method="remove">
<INLINE>
#!/bin/bash

# åœæ­¢ fanctrlplus æœåŠ¡
/usr/local/emhttp/plugins/fanctrlplus/scripts/rc.fanctrlplus stop 2>/dev/null
pkill -f array_monitor.sh

# æ¸…ç†æ’ä»¶æ–‡ä»¶å’Œæ³¨å†Œçš„ rc.d å¯åŠ¨è„šæœ¬
rm -rf /usr/local/emhttp/plugins/fanctrlplus
rm -rf /boot/config/plugins/fanctrlplus
rm -f /etc/rc.d/rc.fanctrlplus

echo "============================================================"
echo "âš ï¸  FanCtrl Plus has been removed."
echo "ğŸ‘‰  To ensure fan control is restored to BIOS or other tools,"
echo "    it is strongly recommended to reboot your Unraid server."
echo "============================================================"
exit 0
</INLINE>
</FILE>

<CHANGES>
Release Notes â€“ ###&version;

New Features and Improvements:
	1.	Reworked status indicator
	    â€¢	The top green/red status dot is now rendered using CSS for consistent styling and visibility.
	2.	Per-fan SVG status indicator
	    â€¢	Each fan block now includes a live SVG icon to indicate control status (Active / Inactive), with automatic rotation and color changes based on running state.
	3.	Safe fallback on Stop
	    â€¢	When clicking the Stop button, any fan that was actively controlled will be set to 50% PWM in manual mode. This helps prevent full-speed ramp-ups or complete fan stalls when BIOS fails to take over.
	4.	Log optimization and UI refinements
	    â€¢	Fixed excessive log writes in earlier versions.
	â€¢	Minor UI alignment and layout improvements.

</CHANGES>
</PLUGIN>
