Menu="Utilities"
Title="FanCtrl Plus"
Icon="fanctrlplus.png"
---
<?PHP
$plugin = "fanctrlplus";

function parse_all_cfg($plugin) {
  $cfg_dir = "/boot/config/plugins/$plugin";
  $files = glob("$cfg_dir/{$plugin}_*.cfg");
  $list = [];
  foreach ($files as $f) {
    $cfg = parse_ini_file($f);
    $cfg['file'] = basename($f);
    $list[] = $cfg;
  }
  return $list;
}

function list_pwm() {
  $out = [];
  exec("find /sys/devices -type f -iname 'pwm[0-9]' -exec dirname \"{}\" + | uniq", $chips);
  foreach ($chips as $chip) {
    $name = is_file("$chip/name") ? file_get_contents("$chip/name") : '';
    foreach (glob("$chip/pwm[0-9]") as $pwm) {
      $out[] = ['chip'=>$name, 'name'=>basename($pwm), 'sensor'=>$pwm];
    }
  }
  return $out;
}

function list_valid_disks_by_id() {
  $seen = [];
  $result = [];
  foreach (glob("/dev/disk/by-id/*") as $dev) {
    if (!is_link($dev) || strpos($dev, "part") !== false) continue;
    $real = realpath($dev);
    if (strpos($real, "/dev/sd") === false && strpos($real, "/dev/nvme") === false) continue;
    if (in_array($real, $seen)) continue;
    $seen[] = $real;
    $result[] = ['id' => basename($dev), 'dev' => $real];
  }
  return $result;
}

$all_cfg = parse_all_cfg($plugin);
$disks = list_valid_disks_by_id();
$pwms = list_pwm();
$width = 300;
?>
<style>
.fan-pair { display: flex; flex-wrap: wrap; gap: 20px; }
.fan-block {
  flex: 1 1 48%;
  border: 1px solid #ccc;
  padding: 10px;
  margin-bottom: 15px;
  position: relative;
}
.fan-block .remove-btn {
  position: absolute;
  top: 5px;
  right: 10px;
  color: red;
  cursor: pointer;
  font-weight: bold;
}
</style>

<script>
function pauseFan(pwm, btn) {
  $(btn).prop('disabled', true).text("Pausing...");
  $.get('/plugins/fanctrlplus/include/FanctrlLogic.php', {op:'pause', pwm:pwm}, function() {
    let seconds = 30;
    let interval = setInterval(function() {
      if (seconds <= 0) {
        clearInterval(interval);
        $(btn).text("Pause 30s").prop('disabled', false);
      } else {
        $(btn).text("Paused (" + seconds + "s)");
        seconds--;
      }
    }, 1000);
  });
}

function removeFan(btn) {
  $(btn).closest('.fan-block').remove();
}

function addFan() {
  let html = $('#fanTemplate').html();
  let index = $('.fan-block').length;
  html = html.replace(/__INDEX__/g, index);
  $('#fanContainer').append(html);
  $('.disk-select').dropdownchecklist({emptyText:'(None)', width:<?=$width?>, explicitClose:'...close'});
}

$(function() {
  $('.disk-select').dropdownchecklist({emptyText:'(None)', width:<?=$width?>, explicitClose:'...close'});
});
</script>

<form method="POST" action="/update.php" target="progressFrame">
  <input type="hidden" name="#include" value="plugins/fanctrlplus/include/update.fanctrlplus.php">

  <div id="fanContainer" class="fan-pair">
<? foreach ($all_cfg as $i => $cfg): ?>
  <div class="fan-block">
    <span class="remove-btn" onclick="removeFan(this)">ðŸ—‘</span>
    <input type="hidden" name="#file[<?=$i?>]" value="fanctrlplus/<?=$cfg['file']?>">

    <table>
      <tr>
        <td>Fan Control:</td>
        <td>
          <select name="service[<?=$i?>]">
            <option value="0" <?=($cfg['service']??'')=='0'?'selected':''?>>Disabled</option>
            <option value="1" <?=($cfg['service']??'')=='1'?'selected':''?>>Enabled</option>
          </select>
        </td>
      </tr>
      <tr>
        <td>PWM Controller:</td>
        <td>
          <select name="controller[<?=$i?>]">
            <? foreach ($pwms as $pwm): ?>
            <option value="<?=$pwm['sensor']?>" <?=($cfg['controller']??'')==$pwm['sensor']?'selected':''?>><?=$pwm['chip']?> - <?=$pwm['name']?></option>
            <? endforeach; ?>
          </select>
          <button type="button" onclick="pauseFan($(this).prev().val(), this)">Pause 30s</button>
        </td>
      </tr>
      <tr><td>Min PWM:</td><td><input type="text" name="pwm[<?=$i?>]" value="<?=$cfg['pwm']??''?>"></td></tr>
      <tr><td>Low Temp (Â°C):</td><td><input type="number" name="low[<?=$i?>]" value="<?=$cfg['low']??''?>"></td></tr>
      <tr><td>High Temp (Â°C):</td><td><input type="number" name="high[<?=$i?>]" value="<?=$cfg['high']??''?>"></td></tr>
      <tr><td>Interval (min):</td><td><input type="number" name="interval[<?=$i?>]" value="<?=$cfg['interval']??''?>"></td></tr>
      <tr>
        <td>Include Disks:</td>
        <td>
          <select class="disk-select" name="disks[<?=$i?>][]" multiple style="width:400px;">
            <? foreach ($disks as $d):
              $id = $d['id'];
              $sel = in_array($id, explode(',', $cfg['disks']??'')) ? 'selected' : '';
            ?>
              <option value="<?=$id?>" <?=$sel?>><?=$id?> â†’ <?=$d['dev']?></option>
            <? endforeach; ?>
          </select>
        </td>
      </tr>
    </table>
  </div>
<? endforeach; ?>
  </div>

  <div>
    <button type="button" onclick="addFan()">âž• Add Fan</button>
  </div>
  <br>
  <input type="submit" name="#apply" value="Apply">
  <input type="submit" name="#default" value="Default">
</form>

<!-- hidden template -->
<div id="fanTemplate" style="display:none">
  <div class="fan-block">
    <span class="remove-btn" onclick="removeFan(this)">ðŸ—‘</span>
    <table>
      <tr>
        <td>Fan Control:</td>
        <td>
          <select name="service[__INDEX__]">
            <option value="0">Disabled</option>
            <option value="1">Enabled</option>
          </select>
        </td>
      </tr>
      <tr>
        <td>PWM Controller:</td>
        <td>
          <select name="controller[__INDEX__]">
            <? foreach ($pwms as $pwm): ?>
            <option value="<?=$pwm['sensor']?>"><?=$pwm['chip']?> - <?=$pwm['name']?></option>
            <? endforeach; ?>
          </select>
          <button type="button" onclick="pauseFan($(this).prev().val(), this)">Pause 30s</button>
        </td>
      </tr>
      <tr><td>Min PWM:</td><td><input type="text" name="pwm[__INDEX__]" value="120"></td></tr>
      <tr><td>Low Temp (Â°C):</td><td><input type="number" name="low[__INDEX__]" value="35"></td></tr>
      <tr><td>High Temp (Â°C):</td><td><input type="number" name="high[__INDEX__]" value="50"></td></tr>
      <tr><td>Interval (min):</td><td><input type="number" name="interval[__INDEX__]" value="5"></td></tr>
      <tr>
        <td>Include Disks:</td>
        <td>
          <select class="disk-select" name="disks[__INDEX__][]" multiple style="width:400px;">
            <? foreach ($disks as $d): ?>
              <option value="<?=$d['id']?>"><?=$d['id']?> â†’ <?=$d['dev']?></option>
            <? endforeach; ?>
          </select>
        </td>
      </tr>
    </table>
  </div>
</div>
