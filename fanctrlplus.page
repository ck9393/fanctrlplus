Menu="Utilities"
Title="FanCtrl Plus"
Icon="fanctrlplus.png"
---

<?PHP
$plugin = "fanctrlplus";
$cfg_dir = "/boot/config/plugins/$plugin";

// ÂàùÂßãÂåñÈÖçÁΩÆ
if (!is_dir($cfg_dir)) {
  mkdir($cfg_dir, 0777, true);
}

$all_cfg = [];
foreach (glob("$cfg_dir/{$plugin}_*.cfg") as $file) {
  $cfg = parse_ini_file($file);
  $cfg['file'] = basename($file);
  $all_cfg[] = $cfg;
}

if (empty($all_cfg)) {
  $temp_file = "$cfg_dir/{$plugin}_temp_0.cfg";
  if (!file_exists($temp_file)) {
    file_put_contents($temp_file, "custom=\"\"\nservice=\"1\"\ncontroller=\"\"\npwm=\"100\"\nlow=\"40\"\nhigh=\"60\"\ninterval=\"2\"\ndisks=\"\"");
  }
  $all_cfg[] = parse_ini_file($temp_file) + ['file' => basename($temp_file)];
}

function list_pwm() {
  $out = [];
  exec("find /sys/devices -type f -iname 'pwm[0-9]' -exec dirname \"{}\" + | uniq", $chips);
  foreach ($chips as $chip) {
    $name = is_file("$chip/name") ? file_get_contents("$chip/name") : '';
    foreach (glob("$chip/pwm[0-9]") as $pwm) {
      $out[] = ['chip'=>$name, 'name'=>basename($pwm), 'sensor'=>$pwm];
    }
  }
  return $out;
}

function list_valid_disks_by_id() {
  $seen = [];
  $result = [];

  // Ëé∑Âèñ Unraid ÂêØÂä®ÁõòÂØπÂ∫îÁöÑËÆæÂ§áÔºå‰æãÂ¶Ç /dev/sda1 Êàñ /dev/sdb1
  $boot_mount = realpath("/boot");
  $boot_dev = exec("findmnt -n -o SOURCE --target $boot_mount 2>/dev/null");
  $boot_dev_base = preg_replace('#[0-9]+$#', '', $boot_dev);  // ÂéªÈô§ÂàÜÂå∫Âè∑Ôºå‰æãÂ¶Ç /dev/sda1 ‚Üí /dev/sda

  foreach (glob("/dev/disk/by-id/*") as $dev) {
    if (!is_link($dev) || strpos($dev, "part") !== false) continue;

    $real = realpath($dev);
    if ($real === false) continue;

    // Âè™‰øùÁïô sdX Êàñ nvme ËÆæÂ§á
    if (strpos($real, "/dev/sd") === false && strpos($real, "/dev/nvme") === false) continue;

    // Ë∑≥Ëøá Unraid ÂêØÂä®ÁöÑËÆæÂ§áÔºà‰æãÂ¶Ç /dev/sdaÔºâ
    if (strpos($real, $boot_dev_base) === 0) continue;

    if (in_array($real, $seen)) continue;

    $seen[] = $real;
    $result[] = ['id' => basename($dev), 'dev' => $real];
  }

  return $result;
}

$pwms = list_pwm();
$disks = list_valid_disks_by_id();
$width = 300;
?>

<p style="margin: 4px 0 12px 12px; font-size:13px; font-weight:normal;">
  <span style="font-weight:bold;">Fan Control:</span>
  <span id="status-value" style="color:green;">Active</span>
</p>

<script>
$(function() {
  function updateFanControlStatus(isRunning) {
    const statusElem = document.getElementById('status-value');
    if (!statusElem) return;
    statusElem.textContent = isRunning ? 'Active' : 'Inactive';
    statusElem.style.color = isRunning ? 'green' : 'red';
  }

  function updateStatusLightAndButton() {
    $.get('/plugins/fanctrlplus/include/FanctrlLogic.php', {op: 'status'}, function(statusObj) {
      const isRunning = statusObj.status === 'running';
      updateFanControlStatus(isRunning);  // ‚úÖ Ê∑ªÂä†ËøôË°å
      const btn = $('#toggle-daemon');
      btn.text(isRunning ? '‚èπÔ∏è Stop' : '‚ñ∂Ô∏è Start');
      btn.prop('disabled', false);
    }).fail(function(jqXHR, textStatus, errorThrown) {
      console.error("‚ùå Failed to load status:", textStatus, errorThrown);
    });
  }

  function updateAllFanStatus() {
    console.log("‚úÖ updateAllFanStatus triggered");
    $.get('/plugins/fanctrlplus/include/FanctrlLogic.php', {op: 'status_all'}, function(statusMap) {
      console.log("‚úÖ statusMap:", statusMap);

      $('.fan-block').each(function() {
        const block = $(this);
        const name = block.find('input[name^="custom["]').val().trim();
        const indicator = block.find('.fan-status');

        console.log("‚Üí block:", name, "indicator exists:", indicator.length > 0);

        if (!indicator.length) return;

        const matchedKey = Object.keys(statusMap).find(k => k.toLowerCase() === name.toLowerCase());
        const status = matchedKey ? statusMap[matchedKey] : 'stopped';

        console.log("‚Üí matchedKey:", matchedKey, "status:", status);

        indicator.text(status === 'running' ? 'üü¢' : 'üî¥');
      });
    }).fail(function(jqXHR, textStatus, errorThrown) {
      console.error("‚ùå Failed to load status_all:", textStatus, errorThrown);
    });
  }
  updateStatusLightAndButton();
  updateAllFanStatus();

  setInterval(function() {
    updateStatusLightAndButton();
    updateAllFanStatus();
  }, 30000);

  window.toggleDaemon = function() {
    const btn = $('#toggle-daemon');
    btn.prop('disabled', true);
    const action = btn.text().includes('Stop') ? 'stop' : 'start';

    $.get('/plugins/fanctrlplus/include/FanctrlLogic.php', {op: action}, function() {
      // ÊØè 500ms Ê£ÄÊü•‰∏ÄÊ¨°ÔºåÊúÄÂ§öÁ≠â 10 Ê¨°Ôºà5 ÁßíÔºâ
      let tries = 0;
      const maxTries = 10;

      const check = () => {
        $.get('/plugins/fanctrlplus/include/FanctrlLogic.php', {op: 'status'}, function(data) {
          const isRunning = data.status === 'running';
          const wantRunning = action === 'start';

          if (isRunning === wantRunning || tries >= maxTries) {
            updateStatusLightAndButton();
            updateAllFanStatus();
            btn.prop('disabled', false);
          } else {
            tries++;
            setTimeout(check, 500);
          }
        });
      };

    check();
  }).fail(function(jqXHR, textStatus, errorThrown) {
    console.error("‚ùå Toggle daemon failed:", textStatus, errorThrown);
    btn.prop('disabled', false);
  });
};

  window.pauseFan = function(pwm, btn) {
    $(btn).prop('disabled', true).text("Pausing...");
    $.get('/plugins/fanctrlplus/include/FanctrlLogic.php', {op:'pause', pwm:pwm}, function() {
      let seconds = 30;
      let interval = setInterval(function() {
        if (seconds <= 0) {
          clearInterval(interval);
          $(btn).text("Pause 30s").prop('disabled', false);
        } else {
          $(btn).text("Paused (" + seconds + "s)");
          seconds--;
        }
      }, 1000);
    });
  };

  window.removeFan = function(btn) {
    if (!confirm("Are you sure you want to delete this fan configuration?")) return;
    const block = $(btn).closest('.fan-block');
    const file = block.find('input.cfg-file').val();

    $.post('/plugins/fanctrlplus/include/FanctrlLogic.php', {op:'delete', file: file})
      .done(function(result) {
        console.log("‚úÖ Fan deleted:", result);
        block.remove();                  // ‚úÖ ÂÖà‰ªéÈ°µÈù¢ÁßªÈô§
        setTimeout(() => {
          updateAllFanStatus();         // ‚úÖ ÁÑ∂ÂêéÂà∑Êñ∞ status ÁÅØ
        }, 500);
      })
      .fail(function(jqXHR, textStatus, errorThrown) {
        console.error("‚ùå Delete fan failed:", textStatus, errorThrown);
        alert("Failed to delete fan.");
      });
  };

  window.addFan = function() {
    console.log("üü° Add Fan clicked"); // ÂÖàÁúãÊòØÂê¶ÁÇπÂáªËß¶Âèë
    const index = $('.fan-block').length;
    $.post('/plugins/fanctrlplus/include/FanctrlLogic.php', {op:'newtemp', index: index})
      .done(function(resp) {
        console.log("üü¢ Fan added:", resp);
      })
      .fail(function(jqXHR, textStatus, errorThrown) {
        console.error("üî¥ Add fan failed:", textStatus, errorThrown);
      })
      .always(function() {
        location.reload();  // ‰øùÂ∫ïÂà∑Êñ∞
      });
  };

  $('.disk-select').each(function() {
    $(this).dropdownchecklist({emptyText:'(None)', width:<?=$width?>, explicitClose:'...close'});
  });

  $('form input, form select, form textarea').on('change keyup', function() {
    $('form').trigger('ui:changed');
  });

  $('form').on('submit', function() {
    let valid = true;
    $('input[name^="custom["]').each(function() {
      if ($(this).val().trim() === '') {
        alert("Custom Name cannot be empty!");
        $(this).focus();
        valid = false;
        return false;
      }
    });
    return valid;
  });
});
</script>

<form method="POST" action="/update.php" target="progressFrame">
  <input type="hidden" name="#include" value="plugins/fanctrlplus/include/update.fanctrlplus.php">
  <div id="fan-area">
    <? foreach ($all_cfg as $i => $cfg): ?>
    <div class="fan-block" style="display:inline-block; width:48%; vertical-align:top;">
      <input type="hidden" name="#file[<?=$i?>]" value="<?=$cfg['file']?>" class="cfg-file">
      <fieldset style="margin:10px 0; padding:34px 16px 12px 16px; border:1px solid #ccc; border-radius:6px; position:relative;">
        <span class="fan-status" style="position:absolute; top:6px; right:8px;">üîÑ</span>
        <button type="button" onclick="removeFan(this)" title="Delete this fan configuration" style="position:absolute; bottom:6px; right:8px;">DELETE</button>
        <table style="width:100%;">
          <tr>
            <td style="cursor: help;" title="Enter a unique name for this fan. Avoid spaces or special characters.">Custom Name</td>
            <td>
              <input type="text" name="custom[<?=$i?>]" value="<?=htmlspecialchars($cfg['custom']??'')?>" placeholder="Required (e.g. HDDBay)" required>
            </td>
          </tr>
          <tr>
            <td style="cursor: help;" title="Enable or disable this fan controller">Fan Control:</td>
            <td>
              <select name="service[<?=$i?>]">
                <option value="0" <?=($cfg['service']??'')=='0'?'selected':''?>>Disabled</option>
                <option value="1" <?=($cfg['service']??'')=='1'?'selected':''?>>Enabled</option>
              </select>
            </td>
          </tr>
          <tr>
            <td style="cursor: help;" title="Select the PWM controller for this fan">PWM Controller:</td>
            <td>
              <select name="controller[<?=$i?>]">
                <?foreach ($pwms as $pwm):?>
                <option value="<?=$pwm['sensor']?>" <?=($cfg['controller']??'')==$pwm['sensor']?'selected':''?>><?=$pwm['chip']?> - <?=$pwm['name']?></option>
                <?endforeach;?>
              </select>
              <button type="button" onclick="pauseFan($(this).prev().val(), this)" title="Pause this fan for 30 seconds to identify its location.">Pause 30s</button>
            </td>
          </tr>
          <tr>
            <td style="cursor: help;" title="Set the minimum PWM value (0‚Äì255)">Min PWM:</td>
            <td>
              <input type="text" name="pwm[<?=$i?>]" value="<?=htmlspecialchars($cfg['pwm']??'')?>">
            </td>
          </tr>
          <tr>
            <td style="cursor: help;" title="At or below this temperature, fan will run at the configured minimum PWM">Low Temp (¬∞C):</td>
            <td>
              <input type="number" name="low[<?=$i?>]" value="<?=htmlspecialchars($cfg['low']??'')?>">
            </td>
          </tr>
          <tr>
            <td style="cursor: help;" title="At or above this temperature, fan will run at the configured maximum PWM">High Temp (¬∞C):</td>
            <td>
              <input type="number" name="high[<?=$i?>]" value="<?=htmlspecialchars($cfg['high']??'')?>">
            </td>
          </tr>
          <tr>
            <td style="cursor: help;" title="Check temperature and adjust fan speed every X minutes.">Interval (min):</td>
            <td>
              <input type="number" name="interval[<?=$i?>]" value="<?=htmlspecialchars($cfg['interval']??'')?>">
            </td>
          </tr>
          <tr>
            <td style="cursor: help;" title="Select disk(s) to monitor for temperature control.">Include Disk(s):</td>
            <td>
              <select class="disk-select" name="disks[<?=$i?>][]" multiple style="width:400px;">
                <?foreach ($disks as $d):
                  $id = $d['id'];
                  $sel = in_array($id, explode(',', $cfg['disks']??'')) ? 'selected' : '';
                ?>
                <option value="<?=$id?>" <?=$sel?>><?=$id?> ‚Üí <?=$d['dev']?></option>
                <?endforeach;?>
              </select>
            </td>
          </tr>
        </table>
      </fieldset>
    </div>
    <? endforeach; ?>
    <div style="clear:both; margin-top:15px; text-align: left;">
      <button type="button" onclick="addFan()" title="Add a new fan controller block">‚ûï Add Fan</button>
      <input type="submit" name="#apply" value="Apply All" title="Save all fan configurations">
      <button type="button" id="toggle-daemon" onclick="toggleDaemon()" disabled>Loading...</button>
    </div>
</form>
